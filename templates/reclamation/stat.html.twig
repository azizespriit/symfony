{% extends 'baseback.html.twig' %}

{% block title %}Reclamation Statistics{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="mb-4">Reclamation Statistics by User</h1>

    {% if stats is empty %}
        <div class="alert alert-info" role="alert">
            No reclamation data available.
        </div>
    {% else %}
        <!-- Table for Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Detailed Statistics</h2>
            </div>
            <div class="card-body">
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">User ID</th>
                            <th scope="col">Email</th>
                            <th scope="col">Reclamations</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in stats %}
                            <tr>
                                <td>{{ stat.userId }}</td>
                                <td>{{ stat.email|default('N/A') }}</td>
                                <td>{{ stat.reclamationCount }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chart for Visualization -->
        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">Reclamations per User</h2>
            </div>
            <div class="card-body">
                <canvas id="reclamationChart" height="100"></canvas>
            </div>
        </div>
    {% endif %}
</div>

{% block javascripts %}
    {% if stats is not empty %}
        <!-- Include Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const ctx = document.getElementById('reclamationChart').getContext('2d');
                
                // Prepare data for Chart.js
                const labels = [{% for stat in stats %}'{{ stat.email|default('User ' ~ stat.userId) }}'{% if not loop.last %},{% endif %}{% endfor %}];
                const data = [{% for stat in stats %}{{ stat.reclamationCount }}{% if not loop.last %},{% endif %}{% endfor %}];

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Reclamations',
                            data: data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Reclamations'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Users'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        </script>
    {% endif %}
{% endblock %}
{% endblock %}